---
layout: post
title: Installing a Fresh Windows OS to a New Bootable VHD with no Host OS for Boot to VHD
date: 2011-05-07 06:24
author: John
comments: true
categories: [boot, vhd, windows]
---
<p>I love the performance gains I get by using bootable VHDs. I’ve always enjoyed using VHDs but I generally had a host OS first, then installed a bunch of VHDs that I made bootable. Recently I’ve changed all of this on my laptop after a coworker took the time to show me a way with more flexibility (thanks <a href="http://blogs.msdn.com/pstubbs">Paul Stubbs</a>!). The idea is simple: take a clean drive with no host OS and add or remove bootable VHDs as needed.</p> <p>These steps describe steps that enable a few scenarios for me that allow me to:</p> <ol> <li>Install a fresh OS to a new bootable VHD with no host OS on the computer already  <li>Copy existing VHDs to my physical drive and make them bootable  <li>Boot to any of my VHDs and copy others on, or take some off </li></ol> <p><span style="color: #ff0000" color="#ff0000">To be very clear, these steps are for taking a brand new hard drive or wiping a hard drive clean, and then installing a series of OS’s on VHDs that will boot from disk.</span> The advantage of this is there is no host OS, you can have as many bootable VHDs that fit on disk, and they can be copied on and off the disk at will. I also use create differencing disks (I’ll get into that in another post).</p> <p>I like this technique so I don’t have to rely on a base OS. This allows me to copy VHDs on my hard disk, add them to the boot record and run. Or I can install a new OS to a brand new VHD from a DVD, USB or network install. It’s very flexible and since the VHDs boot from the metal they are run very fast!</p> <p>This creates a VHD on the metal, on you hard drive without needing a host OS.</p> <blockquote> <p><span style="color: #ff0000" color="#ff0000">NOTE: This post contains a lot of command line operations that are if typed incorrectly can wipe a hard drive, lose its data, and make it unrecoverable. Use these steps at your own risk, I am not responsible for the outcome. I am simply sharing what works for me.</span></p></blockquote> <p>I recommend using an SSD if you can. I have found that the performance differences of running off a traditional drive vs. a SSD are tremendous. They are pricey, but I’ve been able to upgrade to an SSD and give my laptop new life.</p> <h2>Install Windows 7 On a Completely Clean Drive, with No Existing OS</h2> <p>This cleans my hard drive and sets it up for my 1st VHD that will boot off the metal. These steps only need to be done once to clean the drive fresh. In fact, I don’t ever want to do this again to the drive because it wipes it completely clean (have I repeated that enough times yet? Can you tell I am very careful?)</p> <ol> <li>First, I need to have an OS to install.  <ol> <li>If installing from DVD/CD, I make sure the media is in the drive and the bios is set to boot from the optical drive. Then reboot  <li>If installing Windows 7 from USB, I make sure the USB is plugged in and the bios is set to enable USB boot. Then reboot  <li>If installing from the network, after reboot press F12 (if that’s my shortcut key to LAN install) and select the boot OS option. </li></ol> <li>Once Windows Setup begins and prompts me to begin the installation, I press SHIFT-F10 to get to a command prompt. This is where I will create a VHD and then install the OS onto it.  <li>In the command windows, I enter the disk partitioning utility  <div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">DISKPART</pre></div>
<li>Now I list the disks and take note of the disk number for the physical hard drive.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">list disk</pre></div>
<li>Assuming the disk was number 0, I select that disk.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #0000ff">select</span> disk 0</pre></div>
<li>Now I wipe the drive clean (all of my data on this drive will disappear). I do this so I can start fresh.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">clean</pre></div>
<li>Now my drive is clean and ready to be set up. Next I created a partition and formatted it with NTFS file system using quick format. I labeled it “256 GB SSD” so I would always know where the physical drive was. Then I marked it as an active system drive and assigned it a drive letter of C.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">create part primary<br>format fs=ntfs label=<span style="color: #006080">"256 GB SSD"</span> quick<br>active<br>assign letter=c</pre></div>
<li>At this point I have a fresh drive ready for some VHDs! The next step could be to continue the install of the OS (see next section). </li></ol>
<h2>Install a Fresh Copy of Windows 7 on the Metal, in a Bootable VHD</h2>
<p>If I followed the previous steps, I am still in DISKPART. If not, I would follow steps 1-3 in the section above first.</p>
<p>I repeat these steps whenever I need to install a new fresh OS. I can have as many as my drives fits.</p>
<ol>
<li>I start by creating a new VHD on the metal where the OS will be installed. It allows me to choose a fixed size or expandable virtual disk file.The advantage of using fixed is that it will always consume X amount of space and be able to boot. Expandable VHDs take up much less space when not used, but they need to have room to expand when they are booted into. I generally use expandable.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">create vdisk file=c:\win7.vhd maximum=50000 type=expandable</pre></div>
<li>Now I select the VHD, attach to it, create a partition on it, and format it. Then I marked it as an active system drive and assigned it a drive letter.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><p><span style="color: #0000ff">select</span> vdisk file=c:\win7.vhd<br>attach vdisk <br>create part primary<br>format fs=ntfs label=<span style="color: #006080">"Win7"</span> quick</p><p>active</p><p>assign<br></p></pre></div>
<li>Then I exit from DISKPART and exit from the command prompt by typing exit,and exit. This brings me back to the Windows 7 install screen which is waiting for me.
<li>I can now proceed with installation, making sure I choose a custom installation when promoted. Of course, I have to choose the partition I just created. The installation of Windows 7 will happen on the VHD I just created and boot right off the metal. This process creates boot records for me, so I don’t need to create entries using BCDEDIT in the boot record manually which is nice. </li></ol>
<h2>Add an Existing VHD to Boot off the Metal</h2>
<p><a name="_MailAutoSig"></a></p>
<p>Sometimes I have an existing VHD that is ready to go and I want to copy it to my computer and run it off the metal. Here are the steps I use to do that. For these steps, I’ll assume I have a Windows 7 VHD with some cool demos on it called Win7MIX11.vhd.</p>
<ol>
<li>Boot into Windows 7 (for example, one of my bootable VHDs of Win 7)
<li>I copy the Win7MIX11.vhd file to the physical hard drive (might take a few minutes)
<li>Open a Command prompt using Run as Administrator
<li>I run the DISKPART utility
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">DISKPART</pre></div>
<li>I attach to the VHD and exit the DISKPART utility
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #0000ff">select</span> vdisk file=c:\Win7Mix11.vhd<br>attach vdisk<br>exit</pre></div>
<li>Now I make it bootable, making sure I use the drive letter that the VHD is attached to (I assume X here).
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">BCDBOOT x:\Windows</pre></div>
<li>Next I create the boot records so this VHD will be in the list of boot options when I reboot the computer. First I copy a record and give it a name.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">bcdedit /copy {current} /d <span style="color: #006080">"MIX11 Demos"</span></pre></div>
<li>Then I take the GUID that the previous command created and I copy it to the clipboard. I will use this a few times in the next statements.
<li>I enter the follow commands in order, replacing the {myguid} with the GUID I copied to my clipboard a moment ago.
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">bcdedit /set {myguid} device vhd=[locate]\Win7Mix11.vhd<br>bcdedit /set {myguid} osdevice vhd=[locate]\Win7Mix11.vhd<br>bcdedit /set {myguid} detecthal on</pre></div>
<li>Now I can reboot and my Windows 7 VHD for Mix11 demos should show up in my boot options as “MIX1 Demos” </li></ol>
<h2>Verification</h2>
<p>Here is a screen capture of my Windows Explorer when I am booted into one of my Win7 VHDs. The D: drive is my physical hard drive, my SSD. Now that I see this I realize I should have made that the C drive letter. Oops. Not a big deal obviously.<img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/wlEmoticon-smile_2.png"></p>
<p><a href="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/Capture1_1.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Capture1" border="0" alt="Capture1" src="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/Capture1_thumb_1.png" width="504" height="89"></a></p>
<p>The C: drive is the VHD I am booted into. The total size of my 256 GB SSD is actually 238 GB of usable space. The “Win7 Papa” VHD is booted and is expanded to 50GB. That file exists on the physical SSD. Any other VHDs are also on the SSD. here is the SSD in Windows Explorer. Notice that my file Win7Personal.vhd is expanded to 50GB … this is the VHD I am currently running (which is why its expanded). The other file, win7-01.vhd, is another VHD that I can boot into. It currently takes up 11GB, tho it will also expand to 50GB when I boot to it (and if I do boot to it, the other VHD will no longer be expanded).</p>
<p><a href="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/image_2.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/image_thumb.png" width="504" height="56"></a></p>
<p>Here is what the Disk Management window shows for my laptop. Notice the SSD and the currently booted VHD show up here too.</p>
<p><a href="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/image_4.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/wp-content/uploads/media/Windows-Live-Writer/428f6aedc0fc_13111/image_thumb_1.png" width="504" height="51"></a></p>
<h2>Wrap Up</h2>
<p>This has worked very well for me recently. In addition to Paul Stubb’s help, there are plenty of other resources on the web that I used to help me along, so I wanted to include some of them here too:</p>
<ul>
<li><a href="http://www.hanselman.com/blog/LessVirtualMoreMachineWindows7AndTheMagicOfBootToVHD.aspx">Less Virtual, More Machine by Scott Hanselman</a>
<li><a href="http://blogs.msdn.com/b/delay/archive/2009/12/03/normal-booting-is-old-school-windows-7-tricks-detailed-usb-key-install-vhd-creation-and-native-vhd-boot-dual-boot.aspx">David Anson’s post on creating VHDs that boot off the metal</a>
<li>Great shots <a href="http://www.zdnet.com/blog/hardware/how-to-getting-started-with-vhd-files-in-windows-7/3324?pg=2">in this post</a> and <a href="http://www.fanhow.com/knowhow:Install_Windows_7_to_VHD_27553253">in this other post</a> of the screens I see when I install a fresh OS and use the SHIFT F10 technique </li></ul>
<p>None of this is earth shattering, its all been done before. I was hesitant at first due to the nature of DISKPART and how a mistake can mean I wiped the drive clean. But recently I decided to upgrade to a new SSD and I had little risk because it was already a new drive. I f you intend on going this route, I recommend researching it first using some f the links I suggested above as well as my experience in this post. But also, make sure you only try this on a drive that is clean or you are OK with wiping clean.</p>

