---
layout: post
title: Upgrading to Entity Framework 4.1 RC
date: 2011-03-16 02:10
author: John
comments: true
categories: [Silverlight]
---
<p>Entity Framework 4.1 RC is out and <a href="http://blogs.msdn.com/b/adonet/archive/2011/03/15/ef-4-1-release-candidate-available.aspx">the team has a great post on what’s included</a> and how to get the bits. I am working on a project using them so I upgraded my code and found a few things that I thought I’d pass along as some tips. Some are more obvious, others might be more special cases that I hit. But either way, it was pretty simple. The entire process took me about 20 minutes, and I was able to walk my colleagues through it in about 5 minutes (typing over Skype).</p> <p>&nbsp;</p> <h3>Upgrading to EF 4.1 RC – 10 Second Overview</h3> <ol> <li>Typed <strong>uninstall-package EFCodeFirst </strong>in the NuGet console  <li>Typed <strong>install-package EntityFramework </strong>in the NuGet console  <li>Updated a few lines of code for some breaking changes from CTP 5 to RC </li></ol> <h3>1. Uninstall Entity Framework 4.1 CTP 5</h3> <p>First, grab <a href="http://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c/">NuGet from here</a>. </p> <ol> <li>The first step is to open the NuGet Package Manager Console by opening the menu:  <ul> <li>View –&gt; Other Windows –&gt; Package Manager Console </li></ul> <li>Make sure the correct project is selected in the drop down (mine is AccoutnsAtAGlance.Model, shown in the figure below)  <li>Type <strong>uninstall-package EFCodeFirst </strong>and click ENTER<a> </a></li></ol> <p>Alternatively, you could use the UI to uninstall NuGet packages. Here are the alternate steps:</p> <ol> <li>Right click your project and select <strong>Add Library Package Reference </strong> <li>Select <strong>Installed Packages </strong>in the left menu  <li>Click the <strong>Uninstall </strong>button next to the EFCodeFirst package </li></ol> <p><a href="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/SNAGHTML545f5af.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="SNAGHTML545f5af" border="0" alt="SNAGHTML545f5af" align="left" src="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/SNAGHTML545f5af_thumb.png" width="576" height="252"></a></p> <h3>2. Install Entity Framework 4.1 RC via NuGet</h3> <p>You can install EF 4.1 RC via a regular download installer, but NuGet is so easy. </p> <ol> <li>The first step is to open the NuGet Package Manager Console by opening the menu:  <ul> <li>View –&gt; Other Windows –&gt; Package Manager Console&nbsp; </li></ul> <li>Make sure the correct project is selected in the drop down (mine is AccoutnsAtAGlance.Model, shown in the figure below)  <li>Type <strong>install-package EntityFramework </strong>and click ENTER<a href="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/image_2.png">&nbsp;<img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" align="left" src="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/image_thumb.png" width="528" height="122"></a> </li></ol> <p>Alternatively, you could use the UI to add NuGet packages. Here are the alternate steps:</p> <ol> <li>Right click your project and select <strong>Add Library Package Reference </strong> <li>Select <strong>Online </strong>in the left menu  <li>Type <strong>EntityFramework</strong> in the search box  <li>Click the <strong>Install </strong>button </li></ol> <p><a href="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/SNAGHTML538d0c1.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="SNAGHTML538d0c1" border="0" alt="SNAGHTML538d0c1" align="left" src="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/SNAGHTML538d0c1_thumb.png" width="595" height="307"></a></p> <h3>3. Tips</h3> <ul> <li>TIP 1 - I use Resharper and for some reason Resharper did not keep up with the changes. It the new API changes in red, even though the project was building. To resolve this you can either force Resharper to refresh its cache or the easiest thing to do is to close your solution and reopen it.  <li>TIP 2 - Where I invoke Stored Procedures (which I admit is rare) I had to change the call from the commented out code to the code below it. The SqlCommand method was renamed ExecuteSqlCommand, which is more of a verb anyway <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/wp-content/uploads/files/media/image/Windows-Live-Writer/94cfa2bb161e_13580/wlEmoticon-smile_2.png"> </li></ul> <div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.55%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; height: 40px; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #008000">//return base.Database.SqlCommand("DeleteAccounts");     </span><br>return <span style="color: #0000ff">base</span>.Database.ExecuteSqlCommand(<span style="color: #006080">"DeleteAccounts"</span>);</pre><br></div>
<ul>
<li>TIP 3 - The ModelBuilder object was renamed to DbModelBuilder. So this code changed, too:
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #008000">//protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span style="color: #0000ff">protected</span> <span style="color: #0000ff">override</span> <span style="color: #0000ff">void</span> OnModelCreating(DbModelBuilder modelBuilder)</pre><br></div></li></ul>
<ul>
<li>TIP 4 - The extension methods MapLeftKey and MapRightKey also changed their overloads. So I had to change this many to many mapping from the commented out code to the code below it. Basically, the lambdas were pretty redundant in CTP 5. </li></ul>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #008000">//modelBuilder.Entity&lt;WatchList&gt;().HasMany(w =&gt; w.Securities)    </span><br><span style="color: #008000">// .WithMany()     </span><br><span style="color: #008000">// .Map(map =&gt; map.ToTable("WatchListSecurity")     </span><br><span style="color: #008000">// .MapRightKey(s =&gt; s.Id, "SecurityId")     </span><br><span style="color: #008000">// .MapLeftKey(wl =&gt; wl.Id, "WatchListId")); </span><br>modelBuilder.Entity&lt;WatchList&gt;().HasMany(w =&gt; w.Securities)<br>       .WithMany()<br>       .Map(map =&gt; map.ToTable(<span style="color: #006080">"WatchListSecurity"</span>)<br>       .MapRightKey(<span style="color: #006080">"SecurityId"</span>)<br>       .MapLeftKey(<span style="color: #006080">"WatchListId"</span>));</pre><br></div>
<ul>
<li>TIP 5 – This one was weird, I admit. For some reason I had to map a model named Security to the table Securities. In CTP 5 this was not necessary, but in the RC I was receiving an error about the mapping for the model Security was not found. Once I added this, all was well. I’ve brought this to the team’s attention as I hope its just something I am doing wrong. If so, I will update this post to clarify it based on what the EF team says. </li></ul>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">modelBuilder.Entity&lt;Security&gt;().ToTable(<span style="color: #006080">"Securities"</span>);</pre><br></div>
<ul>
<li>TIP 6 – This is an API change for the better. The ProxyCreationEnabled property is now a member on the DbContext.Configuration object, so the code went from the commented out code to the code below it. In CTP 5 I had to cast the DbContext variable to IObectContextAdapter and then use the ObjectContext.ConextOptions to get to the property I wanted. Yuck. In EF 4.1 RC I can access both the ProxyCreationEnabled and LazyLoadingEnabled properties off the DbContext.Configuration object. </li></ul>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #008000">//return ((IObjectContextAdapter) _DataContext)</span><br><span style="color: #008000">//.ObjectContext.ContextOptions.ProxyCreationEnabled = false; </span><br><span style="color: #0000ff">return</span> _DataContext.Configuration.ProxyCreationEnabled;</pre><br></div>

